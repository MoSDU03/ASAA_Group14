\section{Formal Verification and Validation}
\label{sec:verification}

\subsection{UPPAAL Model}

We translated the SysML state machine to a network of UPPAAL timed automata. The FillController template contains six locations matching the states in Fig.~\ref{fig:statemachine}, with two clocks: \texttt{fill\_clock} measuring filling duration and \texttt{cycle\_clock} measuring total cycle time.

Location invariants enforce timing bounds: \textit{Filling} has invariant \texttt{fill\_clock $\leq$ 3000} and \textit{WaitingPosition} has \texttt{cycle\_clock $\leq$ 200}. These prevent the model from remaining in time-bounded states beyond specified limits.

Transitions use guards matching SysML conditions:
\begin{lstlisting}[language=C]
// WaitingPosition to Filling
guard: position_sensor_active
sync: position_valid?
assign: valve_open!, fill_clock = 0

// Filling to ClosingValve
guard: current_level >= TARGET_LEVEL - 5
sync: target_reached!
assign: valve_close!
\end{lstlisting}

Global channels (\texttt{can\_detected}, \texttt{position\_valid}, \texttt{valve\_open}, etc.) implement handshaking synchronization between automata, modeling MQTT pub/sub semantics.

\subsection{CTL Properties}

Table~\ref{tab:verification} lists 10 verified properties linking to requirements.
We use UPPAAL's CTL query language where \texttt{\ABox} means ``for all paths always,''
\texttt{\EAng} means ``there exists a path where eventually,''
and \texttt{\AAng} means ``for all paths eventually.''

\begin{table}[htbp]
\caption{Verification Results}
\label{tab:verification}
\centering
\small
\begin{tabular}{|l|p{5.5cm}|l|}
\hline
\textbf{Query} & \textbf{Property} & \textbf{Result} \\
\hline
Q1  & \uppaaltt{A[] not deadlock} & Satisfied \\
Q2  & \uppaaltt{E<> FillController.Complete} & Satisfied \\
Q3  & \uppaaltt{A[] Filling => fill_clock <= 3000} & Satisfied \\
Q4  & \uppaaltt{A[] WaitPos => cycle_clock <= 200} & Satisfied \\
Q5  & \uppaaltt{A[] Complete => level in [325,335]} & Satisfied \\
Q6  & \uppaaltt{E<> Fault} & Satisfied \\
Q7  & \uppaaltt{A<> Idle} & Satisfied \\
Q8  & \uppaaltt{E<> (Complete AND cycle in [600,1500])} & Satisfied \\
Q9  & \uppaaltt{A[] (!sensor AND Filling) => Fault} & Satisfied \\
Q10 & \uppaaltt{A[] (timeout AND ClosingValve) => Fault} & Satisfied \\
\hline
\end{tabular}
\end{table}

\textbf{Q1-Q2} verify basic correctness: the system never deadlocks and can reach successful completion. 

\textbf{Q3-Q5} verify timing and quality bounds: filling never exceeds 3000ms (NFR-02), position detection times out at 200ms (NFR-05), and completion only occurs within tolerance (FR-03).

\textbf{Q6-Q7} verify fault handling and liveness: fault states are reachable (for testing) and the system eventually returns to idle (enabling continuous operation).

\textbf{Q8} directly verifies the performance requirement (NFR-01): there exists an execution with cycle time in [600,1500]ms.

\textbf{Q9-Q10} verify safety properties: sensor failures during filling and timeouts lead to fault states (NFR-05, NFR-06).

State space exploration examined 1,847 states in 0.83 seconds, confirming all properties are satisfied.

\subsection{Counter-Examples and Design Refinement}

Initial verification revealed two design defects:

\textbf{Defect 1:} Missing timeout guard on \textit{Filling} -> \textit{ClosingValve} transition. Counter-example showed execution where \texttt{fill\_clock} exceeded 3000ms before transition.

\textit{Fix:} Added guard \texttt{fill\_clock $\leq$ MAX\_FILL\_TIME} to transition. After correction, Q3 verified successfully.

\textbf{Defect 2:} No invariant on \textit{WaitingPosition} location. Counter-example demonstrated indefinite waiting for position signal.

\textit{Fix:} Added location invariant \texttt{cycle\_clock $\leq$ POSITION\_TIMEOUT}. This forces a transition (either to \textit{Filling} if valid, or to \textit{Fault} if timeout). After correction, Q4 verified successfully.

These defects were found and corrected \textit{before any implementation}, demonstrating the value of formal verification. Both issues would have manifested as hard-to-debug timing violations in production code.

\subsection{Simulation Traces}

UPPAAL simulator provided concrete execution traces. For normal operation, witness trace for Q2 showed:
\begin{enumerate}
    \item Idle (0ms)
    \item WaitingPosition (can\_detected, t=0ms)
    \item Filling (position\_valid, t=52ms) 
    \item ClosingValve (target\_reached, t=892ms)
    \item Complete (valve\_closed, t=923ms)
    \item Idle (can\_released, t=1423ms)
\end{enumerate}

This trace predicted 892ms cycle time, which empirical testing confirmed (Section~\ref{sec:evaluation}).

For fault scenarios, traces demonstrated:
\begin{itemize}
    \item Position timeout: Idle to WaitingPosition to Fault at t=203ms
    \item Level sensor failure: Idle to WaitingPosition to Filling to Fault at t=127ms
\end{itemize}

Both meet the \textless 200ms fault detection requirement (NFR-05).